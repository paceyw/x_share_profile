// ===================== DNS 防泄露 =====================

// 国内DNS服务器
const domesticNameservers = [
  "https://223.5.5.5/dns-query", // 阿里DoH
  "https://doh.pub/dns-query" // 腾讯DoH
];
// 国外DNS服务器
const foreignNameservers = [
  "https://208.67.222.222/dns-query", // OpenDNS
  "https://77.88.8.8/dns-query",      // YandexDNS
  "https://1.1.1.1/dns-query",        // CloudflareDNS
  "https://8.8.4.4/dns-query"         // GoogleDNS
];

// DNS配置
const dnsConfig = {
  enable: true,
  listen: "0.0.0.0:1053",
  ipv6: false,
  "prefer-h3": false,
  "respect-rules": true,
  "use-system-hosts": false,
  "cache-algorithm": "arc",
  "enhanced-mode": "fake-ip",
  "fake-ip-range": "198.18.0.1/16",
  "fake-ip-filter": [
    "+.lan",
    "+.local",
    "+.msftconnecttest.com",
    "+.msftncsi.com",
    "localhost.ptlogin2.qq.com",
    "localhost.sec.qq.com",
    "+.in-addr.arpa",
    "+.ip6.arpa",
    "time.*.com",
    "time.*.gov",
    "pool.ntp.org",
    "localhost.work.weixin.qq.com"
  ],
  "default-nameserver": ["223.5.5.5", "1.2.4.8"],
  nameserver: [...foreignNameservers],
  "proxy-server-nameserver": [...domesticNameservers],
  "direct-nameserver": [...domesticNameservers],
  "nameserver-policy": {
    "geosite:private,cn": domesticNameservers
  }
};

// 规则集通用配置
const ruleProviderCommon = {
  type: "http",
  format: "yaml",
  interval: 86400
};

// ===================== 规则集配置（Loyalsoldier + blackmatrix7） =====================

const ruleProviders = {
  // 基础规则：仍用 Loyalsoldier
  reject: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt",
    path: "./ruleset/loyalsoldier/reject.yaml"
  },
  icloud: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt",
    path: "./ruleset/loyalsoldier/icloud.yaml"
  },
  apple: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt",
    path: "./ruleset/loyalsoldier/apple.yaml"
  },

  // Google：用 blackmatrix7，更全，包含 www.google.com 等
  google: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Google/Google.yaml",
    path: "./ruleset/blackmatrix7/google.yaml"
  },

  proxy: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt",
    path: "./ruleset/loyalsoldier/proxy.yaml"
  },
  direct: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt",
    path: "./ruleset/loyalsoldier/direct.yaml"
  },
  private: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt",
    path: "./ruleset/loyalsoldier/private.yaml"
  },
  gfw: {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt",
    path: "./ruleset/loyalsoldier/gfw.yaml"
  },
  "tld-not-cn": {
    ...ruleProviderCommon,
    behavior: "domain",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt",
    path: "./ruleset/loyalsoldier/tld-not-cn.yaml"
  },
  telegramcidr: {
    ...ruleProviderCommon,
    behavior: "ipcidr",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt",
    path: "./ruleset/loyalsoldier/telegramcidr.yaml"
  },
  cncidr: {
    ...ruleProviderCommon,
    behavior: "ipcidr",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt",
    path: "./ruleset/loyalsoldier/cncidr.yaml"
  },
  lancidr: {
    ...ruleProviderCommon,
    behavior: "ipcidr",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt",
    path: "./ruleset/loyalsoldier/lancidr.yaml"
  },
  applications: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt",
    path: "./ruleset/loyalsoldier/applications.yaml"
  },
  
  // X / Twitter：blackmatrix7 规则，包含 x.com 等
  Twitter: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Twitter/Twitter.yaml",
    path: "./ruleset/blackmatrix7/Twitter.yaml"
  },

  // Bahamut / B站港澳台 继续用你原来的
  bahamut: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/Bahamut.txt",
    path: "./ruleset/xiaolin-007/bahamut.yaml"
  },

  // YouTube：blackmatrix7
  YouTube: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/YouTube/YouTube.yaml",
    path: "./ruleset/blackmatrix7/YouTube.yaml"
  },

  // Netflix：blackmatrix7
  Netflix: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Netflix/Netflix.yaml",
    path: "./ruleset/blackmatrix7/Netflix.yaml"
  },

  // Spotify：blackmatrix7
  Spotify: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/Spotify/Spotify.yaml",
    path: "./ruleset/blackmatrix7/Spotify.yaml"
  },

  BilibiliHMT: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/rule/BilibiliHMT.txt",
    path: "./ruleset/xiaolin-007/BilibiliHMT.yaml"
  },

  // AI：黑矩阵的 OpenAI 规则（ChatGPT 等）
  AI: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/OpenAI/OpenAI.yaml",
    path: "./ruleset/blackmatrix7/OpenAI.yaml"
  },

  // TikTok：blackmatrix7
  TikTok: {
    ...ruleProviderCommon,
    behavior: "classical",
    url: "https://cdn.jsdelivr.net/gh/blackmatrix7/ios_rule_script@master/rule/Clash/TikTok/TikTok.yaml",
    path: "./ruleset/blackmatrix7/TikTok.yaml"
  }
};

// ===================== 自定义分流入口（在这里加你自己的域名） =====================
// 写域名后缀就行，会自动生成：DOMAIN-SUFFIX,xxx,对应分组

const customDomainSuffix = {
  "谷歌服务": [
    // "scholar.google.com",
    // "accounts.google.com",
    "antigravity-unleash.goog",
  ],
  "YouTube": [
    // "m.youtube.com",
    // "ytimg.com",
  ],
  "Netflix": [
    // "netflix.com",
  ],
  "电报消息": [
    // "t.me",
  ],
  "AI": [
    // "gemini.google.com",
  ],
  "TikTok": [
    // "tiktokv.com",
  ],
  "X(Twitter)": [
    // "x.com",
    // "twitter.com",
  ],
  "微软服务": [
    // "copilot.microsoft.com",
  ],
  "苹果服务": [
    // "developer.apple.com",
  ],
  "动画疯": [
    // "example.bahamut.com",
  ],
  "哔哩哔哩港澳台": [
    // "bilibili.com",
  ],
  "Spotify": [
    // "open.spotify.com",
  ],
  "节点选择": [
    // 想强制走主节点选择组的自定义域名
  ],
  "全局直连": [
    // 想强制直连的额外域名
  ],
  "漏网之鱼": [
    // 特殊场景：不想被前面规则命中，可以钉在漏网之鱼再手动选分组
  ]
};

// 把 customDomainSuffix 转成 Clash 规则
function buildCustomRules() {
  const res = [];
  Object.entries(customDomainSuffix).forEach(([group, domains]) => {
    if (!Array.isArray(domains)) return;
    domains.forEach(d => {
      const domain = String(d).trim();
      if (!domain) return;
      // 这里统一用 DOMAIN-SUFFIX，如果你只想匹配完整域名，也可以改成 DOMAIN
      res.push(`DOMAIN-SUFFIX,${domain},${group}`);
    });
  });
  return res;
}

// ===================== 基础规则列表 =====================

const baseRules = [
  // 自定义规则（仍然保留）
  "DOMAIN-SUFFIX,googleapis.cn,节点选择",
  "DOMAIN-SUFFIX,gstatic.com,节点选择",
  "DOMAIN-SUFFIX,xn--ngstr-lra8j.com,节点选择",
  "DOMAIN-SUFFIX,github.io,节点选择",
  "DOMAIN,v2rayse.com,节点选择",

  // 规则集
  "RULE-SET,applications,全局直连",
  "RULE-SET,private,全局直连",
  "RULE-SET,reject,广告过滤",
  "RULE-SET,icloud,微软服务",
  "RULE-SET,apple,苹果服务",
  "RULE-SET,YouTube,YouTube",
  "RULE-SET,Netflix,Netflix",
  "RULE-SET,bahamut,动画疯",
  "RULE-SET,Spotify,Spotify",
  "RULE-SET,BilibiliHMT,哔哩哔哩港澳台",
  "RULE-SET,AI,AI",
  "RULE-SET,TikTok,TikTok",
  "RULE-SET,Twitter,X(Twitter)",
  "RULE-SET,google,谷歌服务",
  "RULE-SET,proxy,节点选择",
  "RULE-SET,gfw,节点选择",
  "RULE-SET,tld-not-cn,节点选择",
  "RULE-SET,direct,全局直连",
  "RULE-SET,lancidr,全局直连,no-resolve",
  "RULE-SET,cncidr,全局直连,no-resolve",
  "RULE-SET,telegramcidr,电报消息,no-resolve",

  // 其他
  "GEOSITE,CN,全局直连",
  "GEOIP,LAN,全局直连,no-resolve",
  "GEOIP,CN,全局直连,no-resolve",
  "MATCH,漏网之鱼"
];

// 代理组通用配置
const groupBaseOption = {
  interval: 300,
  timeout: 3000,
  url: "https://www.google.com/generate_204",
  lazy: true,
  "max-failed-times": 3,
  hidden: false
};

// ===================== 主入口 =====================

function main(config) {
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object"
      ? Object.keys(config["proxy-providers"]).length
      : 0;

  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("配置文件中未找到任何代理");
  }

  // 覆盖 DNS
  config.dns = dnsConfig;

  // 先定义各策略组（这里直接把 socks5 写进各分组）
  config["proxy-groups"] = [
    {
      ...groupBaseOption,
      name: "节点选择",
      type: "select",
      "include-all": true,
      filter: "^(?!.*(官网|套餐|流量|异常|剩余)).*$",
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/adjust.svg"
    },
    {
      ...groupBaseOption,
      name: "谷歌服务",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/google.svg"
    },
    {
      ...groupBaseOption,
      name: "YouTube",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/youtube.svg"
    },
    {
      ...groupBaseOption,
      name: "Netflix",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/netflix.svg"
    },
    {
      ...groupBaseOption,
      name: "电报消息",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/telegram.svg"
    },
    {
      ...groupBaseOption,
      name: "AI",
      type: "select",
      proxies: ["节点选择", "socks5"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/chatgpt.svg"
    },
    {
      ...groupBaseOption,
      name: "TikTok",
      type: "select",
      proxies: ["节点选择", "socks5"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/tiktok.svg"
    },
    {
      ...groupBaseOption,
      name: "X(Twitter)",
      type: "select",
      // 可以在这里手动选：节点选择 / 家宽(socks5) / 直连
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/Twitter.svg"
    },
    {
      ...groupBaseOption,
      name: "微软服务",
      type: "select",
      proxies: ["全局直连", "节点选择", "socks5"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/microsoft.svg"
    },
    {
      ...groupBaseOption,
      name: "苹果服务",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/apple.svg"
    },
    {
      ...groupBaseOption,
      name: "动画疯",
      type: "select",
      proxies: ["节点选择", "socks5"],
      "include-all": true,
      filter: "(?i)台|tw|TW",
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/Bahamut.svg"
    },
    {
      ...groupBaseOption,
      name: "哔哩哔哩港澳台",
      type: "select",
      proxies: ["全局直连", "节点选择", "socks5"],
      "include-all": true,
      filter: "^(?!.*(官网|套餐|流量|异常|剩余)).*$",
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/bilibili.svg"
    },
    {
      ...groupBaseOption,
      name: "Spotify",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/xiaolin-007/clash@main/icon/spotify.svg"
    },
    {
      ...groupBaseOption,
      name: "广告过滤",
      type: "select",
      proxies: ["REJECT", "DIRECT"],
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/bug.svg"
    },
    {
      ...groupBaseOption,
      name: "全局直连",
      type: "select",
      proxies: ["DIRECT", "节点选择"],
      "include-all": true,
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/link.svg"
    },
    {
      ...groupBaseOption,
      name: "全局拦截",
      type: "select",
      proxies: ["REJECT", "DIRECT"],
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/block.svg"
    },
    {
      ...groupBaseOption,
      name: "漏网之鱼",
      type: "select",
      proxies: ["节点选择", "socks5", "全局直连"],
      "include-all": true,
      filter: "^(?!.*(官网|套餐|流量|异常|剩余)).*$",
      icon: "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/fish.svg"
    }
  ];

  // 设置规则集 + 规则：自定义规则优先，其后是基础规则
  const finalRules = [...buildCustomRules(), ...baseRules];
  config["rule-providers"] = ruleProviders;
  config["rules"] = finalRules;

  // 保证 proxies 存在
  if (!Array.isArray(config.proxies)) {
    config.proxies = [];
  }

  // 创建前置机场选择器 all，给 ISP 做 dialer-proxy
  const dialerGroupName = "all";
  const allProxies = config.proxies.map(x => x.name);
  config["proxy-groups"].push({
    ...groupBaseOption,
    name: dialerGroupName,
    type: "select",
    proxies: allProxies,
    "include-all": true
  });

  // 添加家宽 ISP 节点
  config.proxies.push({
    name: "ISP",
    server: "*",
    port: 443,
    username: "*",
    password: "*",
    type: "socks5",
    "dialer-proxy": dialerGroupName,
    udp: true
  });

  // socks5 分组：只包含 ISP
  config["proxy-groups"].push({
    ...groupBaseOption,
    name: "socks5",
    type: "select",
    proxies: ["ISP"]
  });

  // 兜底：确保“节点选择”里也有 socks5
  config["proxy-groups"].forEach(g => {
    if (g.name === "节点选择") {
      if (!Array.isArray(g.proxies)) g.proxies = [];
      if (!g.proxies.includes("socks5")) {
        g.proxies.push("socks5");
      }
    }
  });

  // 所有节点统一开启 UDP
  if (Array.isArray(config.proxies)) {
    config.proxies.forEach(p => {
      p.udp = true;
    });
  }

  return config;
}
